<div class="announce instapaper_body md" data-path="2015-01-19-javascriptcore.md" id="file"><article class="markdown-body entry-content" itemprop="text"><table data-table-type="yaml-metadata">
  <thead>
  <tr>
  <th>title</th>

  <th>author</th>

  <th>category</th>

  <th>excerpt</th>

  <th>status</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td><div>JavaScriptCore</div></td>

  <td><div>Nate Cook</div></td>

  <td><div>Cocoa</div></td>

  <td><div>Introduced with OS X Mavericks and iOS 7, the JavaScriptCore framework puts an Objective-C wrapper around WebKit's JavaScript engine, providing easy, fast, and safe access to the world's most prevalent language. Love it or hate it, JavaScript's ubiquity has led to an explosion of developers, tools, and resources along with ultra-fast virtual machines like the one built into OS X and iOS.</div></td>

  <td><div><table>
  <thead>
  <tr>
  <th>swift</th>

  <th>reviewed</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td><div>2.0</div></td>

  <td><div>November 9, 2015</div></td>
  </tr>
  </tbody>
</table></div></td>
  </tr>
  </tbody>
</table>

<p>An updated ranking of programming language popularity is <a href="http://redmonk.com/sogrady/category/programming-languages/">out this week</a>, showing Swift leaping upward through the ranks from 68th to 22nd, while Objective-C holds a strong lead up ahead at #10. Both, however, are blown away by the only other language allowed to run natively on iOS: the current champion, JavaScript.</p>

<p>Introduced with OS X Mavericks and iOS 7, the JavaScriptCore framework puts an Objective-C wrapper around WebKit's JavaScript engine, providing easy, fast, and safe access to the world's most prevalent language. Love it or hate it, JavaScript's ubiquity has led to an explosion of developers, tools, and resources along with ultra-fast virtual machines like the one built into OS X and iOS.</p>

<p>So come, lay aside bitter debates about dynamism and type safety, and join me for a tour of <em>JavaScriptCore.</em></p>

<hr>

<h3><a id="user-content-jscontext--jsvalue" class="anchor" href="#jscontext--jsvalue" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>JSContext</code> / <code>JSValue</code></h3>

<p><code>JSContext</code> is an environment for running JavaScript code. A <code>JSContext</code> instance represents the global object in the environment—if you've written JavaScript that runs in a browser, <code>JSContext</code> is analogous to <code>window</code>. After creating a <code>JSContext</code>, it's easy to run JavaScript code that creates variables, does calculations, or even defines functions:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> context <span class="pl-k">=</span> JSContext()
context<span class="pl-k">.</span>evaluateScript(<span class="pl-s"><span class="pl-pds">"</span>var num = 5 + 5<span class="pl-pds">"</span></span>)
context<span class="pl-k">.</span>evaluateScript(<span class="pl-s"><span class="pl-pds">"</span>var names = ['Grace', 'Ada', 'Margaret']<span class="pl-pds">"</span></span>)
context<span class="pl-k">.</span>evaluateScript(<span class="pl-s"><span class="pl-pds">"</span>var triple = function(value) { return value * 3 }<span class="pl-pds">"</span></span>)
<span class="pl-k">let</span> tripleNum: JSValue <span class="pl-k">=</span> context<span class="pl-k">.</span>evaluateScript(<span class="pl-s"><span class="pl-pds">"</span>triple(num)<span class="pl-pds">"</span></span>)</pre></div>

<div class="highlight highlight-source-objc"><pre>JSContext *context = [[JSContext <span class="pl-c1">alloc</span>] <span class="pl-c1">init</span>];
[context <span class="pl-c1">evaluateScript:</span><span class="pl-s"><span class="pl-pds">@"</span>var num = 5 + 5<span class="pl-pds">"</span></span>];
[context <span class="pl-c1">evaluateScript:</span><span class="pl-s"><span class="pl-pds">@"</span>var names = ['Grace', 'Ada', 'Margaret']<span class="pl-pds">"</span></span>];
[context <span class="pl-c1">evaluateScript:</span><span class="pl-s"><span class="pl-pds">@"</span>var triple = function(value) { return value * 3 }<span class="pl-pds">"</span></span>];
JSValue *tripleNum = [context <span class="pl-c1">evaluateScript:</span><span class="pl-s"><span class="pl-pds">@"</span>triple(num)<span class="pl-pds">"</span></span>];</pre></div>

<p>As that last line shows, any value that comes <em>out</em> of a <code>JSContext</code> is wrapped in a <code>JSValue</code> object. A language as dynamic as JavaScript requires a dynamic type, so <code>JSValue</code> wraps every possible kind of JavaScript value: strings and numbers; arrays, objects, and functions; even errors and the special JavaScript values <code>null</code> and <code>undefined</code>.</p>

<p><code>JSValue</code> includes a host of methods for accessing its underlying value as the correct Foundation type, including:</p>

<table><thead>
<tr>
<th>JavaScript Type</th>
<th><code>JSValue</code> method</th>
<th>Objective-C Type</th>
<th>Swift Type</th>
</tr>
</thead><tbody>
<tr>
<td>string</td>
<td><code>toString</code></td>
<td><code>NSString</code></td>
<td><code>String!</code></td>
</tr>
<tr>
<td>boolean</td>
<td><code>toBool</code></td>
<td><code>BOOL</code></td>
<td><code>Bool</code></td>
</tr>
<tr>
<td>number</td>
<td><code>toNumber</code><br><code>toDouble</code><br><code>toInt32</code><br><code>toUInt32</code></td>
<td><code>NSNumber</code><br><code>double</code><br><code>int32_t</code><br><code>uint32_t</code></td>
<td><code>NSNumber!</code><br><code>Double</code><br><code>Int32</code><br><code>UInt32</code></td>
</tr>
<tr>
<td>Date</td>
<td><code>toDate</code></td>
<td><code>NSDate</code></td>
<td><code>NSDate!</code></td>
</tr>
<tr>
<td>Array</td>
<td><code>toArray</code></td>
<td><code>NSArray</code></td>
<td><code>[AnyObject]!</code></td>
</tr>
<tr>
<td>Object</td>
<td><code>toDictionary</code></td>
<td><code>NSDictionary</code></td>
<td><code>[NSObject : AnyObject]!</code></td>
</tr>
<tr>
<td>Object</td>
<td><code>toObject</code><br><code>toObjectOfClass:</code></td>
<td><em>custom type</em></td>
<td><em>custom type</em></td>
</tr>
</tbody></table>

<p>To retrieve the value of <code>tripleNum</code> from the above example, simply use the appropriate method:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>Tripled: <span class="pl-pse">\(</span><span class="pl-s1">tripleNum<span class="pl-k">.</span>toInt32()</span><span class="pl-pse">)</span><span class="pl-pds">"</span></span>)
<span class="pl-c">// Tripled: 30</span></pre></div>

<div class="highlight highlight-source-objc"><pre><span class="pl-c1">NSLog</span>(<span class="pl-s"><span class="pl-pds">@"</span>Tripled: <span class="pl-c1">%d</span><span class="pl-pds">"</span></span>, [tripleNum <span class="pl-c1">toInt32</span>]);
<span class="pl-c">// Tripled: 30</span></pre></div>

<h3><a id="user-content-subscripting-values" class="anchor" href="#subscripting-values" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Subscripting Values</h3>

<p>We can easily access any values we've created in our <code>context</code> using subscript notation on both <code>JSContext</code> and <code>JSValue</code> instances. <code>JSContext</code> requires a string subscript, while <code>JSValue</code> allows either string or integer subscripts for delving down into objects and arrays:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> names <span class="pl-k">=</span> context<span class="pl-k">.</span>objectForKeyedSubscript(<span class="pl-s"><span class="pl-pds">"</span>names<span class="pl-pds">"</span></span>)
<span class="pl-k">let</span> initialName <span class="pl-k">=</span> names<span class="pl-k">.</span>objectAtIndexedSubscript(<span class="pl-c1">0</span>)
<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>The first name: <span class="pl-pse">\(</span><span class="pl-s1">initialName<span class="pl-k">.</span>toString()</span><span class="pl-pse">)</span><span class="pl-pds">"</span></span>)
<span class="pl-c">// The first name: Grace</span></pre></div>

<div class="highlight highlight-source-objc"><pre>JSValue *names = context[<span class="pl-s"><span class="pl-pds">@"</span>names<span class="pl-pds">"</span></span>];
JSValue *initialName = names[<span class="pl-c1">0</span>];
<span class="pl-c1">NSLog</span>(<span class="pl-s"><span class="pl-pds">@"</span>The first name: <span class="pl-c1">%@</span><span class="pl-pds">"</span></span>, [initialName <span class="pl-c1">toString</span>]);
<span class="pl-c">// The first name: Grace</span></pre></div>

<blockquote>
<p>Swift shows its youth, here—while Objective-C code can take advantage of subscript notation, Swift currently only exposes the <a href="/object-subscripting/">raw methods</a> that should make such subscripting possible: <code>objectForKeyedSubscript()</code> and <code>objectAtIndexedSubscript()</code>.</p>
</blockquote>

<h3><a id="user-content-calling-functions" class="anchor" href="#calling-functions" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Calling Functions</h3>

<p>With a <code>JSValue</code> that wraps a JavaScript function, we can call that function directly from our Objective-C/Swift code using Foundation types as parameters. Once again, JavaScriptCore handles the bridging without any trouble:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> tripleFunction <span class="pl-k">=</span> context<span class="pl-k">.</span>objectForKeyedSubscript(<span class="pl-s"><span class="pl-pds">"</span>triple<span class="pl-pds">"</span></span>)
<span class="pl-k">let</span> result <span class="pl-k">=</span> tripleFunction<span class="pl-k">.</span>callWithArguments([<span class="pl-c1">5</span>])
<span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>Five tripled: <span class="pl-pse">\(</span><span class="pl-s1">result<span class="pl-k">.</span>toInt32()</span><span class="pl-pse">)</span><span class="pl-pds">"</span></span>)</pre></div>

<div class="highlight highlight-source-objc"><pre>JSValue *tripleFunction = context[<span class="pl-s"><span class="pl-pds">@"</span>triple<span class="pl-pds">"</span></span>];
JSValue *result = [tripleFunction <span class="pl-c1">callWithArguments:</span>@[@<span class="pl-c1">5</span>] ];
<span class="pl-c1">NSLog</span>(<span class="pl-s"><span class="pl-pds">@"</span>Five tripled: <span class="pl-c1">%d</span><span class="pl-pds">"</span></span>, [result <span class="pl-c1">toInt32</span>]);</pre></div>

<h3><a id="user-content-exception-handling" class="anchor" href="#exception-handling" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Exception Handling</h3>

<p><code>JSContext</code> has another useful trick up its sleeve: by setting the context's <code>exceptionHandler</code> property, you can observe and log syntax, type, and runtime errors as they happen. <code>exceptionHandler</code> is a callback handler that receives a reference to the <code>JSContext</code> and the exception itself:</p>

<div class="highlight highlight-source-swift"><pre>context<span class="pl-k">.</span>exceptionHandler <span class="pl-k">=</span> { context, exception <span class="pl-k">in</span>
    <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>JS Error: <span class="pl-pse">\(</span><span class="pl-s1">exception</span><span class="pl-pse">)</span><span class="pl-pds">"</span></span>)
}

context<span class="pl-k">.</span>evaluateScript(<span class="pl-s"><span class="pl-pds">"</span>function multiply(value1, value2) { return value1 * value2 <span class="pl-pds">"</span></span>)
<span class="pl-c">// JS Error: SyntaxError: Unexpected end of script</span></pre></div>

<div class="highlight highlight-source-objc"><pre>context.exceptionHandler = ^(JSContext *context, JSValue *exception) {
   <span class="pl-c1">NSLog</span>(<span class="pl-s"><span class="pl-pds">@"</span>JS Error: <span class="pl-c1">%@</span><span class="pl-pds">"</span></span>, exception);
};

[context <span class="pl-c1">evaluateScript:</span><span class="pl-s"><span class="pl-pds">@"</span>function multiply(value1, value2) { return value1 * value2 <span class="pl-pds">"</span></span>];
<span class="pl-c">// JS Error: SyntaxError: Unexpected end of script</span></pre></div>

<h2><a id="user-content-javascript-calling" class="anchor" href="#javascript-calling" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScript Calling</h2>

<p>Now we know how to extract values from a JavaScript environment and call functions defined therein. What about the reverse? How can we get access to our custom objects and methods, defined in Objective-C or Swift, from within the JavaScript realm?</p>

<p>There are two main ways of giving a <code>JSContext</code> access to our native client code: blocks and the <code>JSExport</code> protocol.</p>

<h3><a id="user-content-blocks" class="anchor" href="#blocks" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Blocks</h3>

<p>When an Objective-C block is assigned to an identifier in a <code>JSContext</code>, JavaScriptCore automatically wraps the block in a JavaScript function. This makes it simple to use Foundation and Cocoa classes from within JavaScript—again, all the bridging happens for you. Witness the full power of Foundation string transformations, now accessible to JavaScript:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> simplifyString: <span class="pl-k">@convention</span>(block) <span class="pl-c1">String</span> <span class="pl-k">-&gt;</span> <span class="pl-c1">String</span> <span class="pl-k">=</span> { input <span class="pl-k">in</span>
    <span class="pl-k">let</span> result <span class="pl-k">=</span> input<span class="pl-k">.</span>stringByApplyingTransform(NSStringTransformToLatin, reverse: <span class="pl-c1">false</span>)
    <span class="pl-k">return</span> result?<span class="pl-k">.</span>stringByApplyingTransform(NSStringTransformStripCombiningMarks, reverse: <span class="pl-c1">false</span>) <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
}
context<span class="pl-k">.</span>setObject(<span class="pl-c1">unsafeBitCast</span>(simplifyString, <span class="pl-c1">AnyObject</span><span class="pl-k">.</span><span class="pl-k">self</span>), forKeyedSubscript: <span class="pl-s"><span class="pl-pds">"</span>simplifyString<span class="pl-pds">"</span></span>)

<span class="pl-c1">print</span>(context<span class="pl-k">.</span>evaluateScript(<span class="pl-s"><span class="pl-pds">"</span>simplifyString('안녕하새요!')<span class="pl-pds">"</span></span>))
<span class="pl-c">// annyeonghasaeyo!</span></pre></div>

<div class="highlight highlight-source-objc"><pre>context[<span class="pl-s"><span class="pl-pds">@"</span>simplifyString<span class="pl-pds">"</span></span>] = ^(<span class="pl-c1">NSString</span> *input) {
   <span class="pl-c1">NSMutableString</span> *mutableString = [input <span class="pl-c1">mutableCopy</span>];
   <span class="pl-c1">CFStringTransform</span>((__bridge <span class="pl-c1">CFMutableStringRef</span>)mutableString, <span class="pl-c1">NULL</span>, <span class="pl-c1">kCFStringTransformToLatin</span>, <span class="pl-c1">NO</span>);
   <span class="pl-c1">CFStringTransform</span>((__bridge <span class="pl-c1">CFMutableStringRef</span>)mutableString, <span class="pl-c1">NULL</span>, <span class="pl-c1">kCFStringTransformStripCombiningMarks</span>, <span class="pl-c1">NO</span>);
   <span class="pl-k">return</span> mutableString;
};

<span class="pl-c1">NSLog</span>(<span class="pl-s"><span class="pl-pds">@"</span><span class="pl-c1">%@</span><span class="pl-pds">"</span></span>, [context <span class="pl-c1">evaluateScript:</span><span class="pl-s"><span class="pl-pds">@"</span>simplifyString('안녕하세요!')<span class="pl-pds">"</span></span>]);</pre></div>

<blockquote>
<p>There's another speedbump for Swift here—note that this only works for <em>Objective-C blocks</em>, not Swift closures. To use a Swift closure in a <code>JSContext</code>, it needs to be (a) declared with the <code>@convention(block)</code> attribute, and (b) cast to <code>AnyObject</code> using Swift's knuckle-whitening <code>unsafeBitCast()</code> function.</p>
</blockquote>

<h4><a id="user-content-memory-management" class="anchor" href="#memory-management" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Memory Management</h4>

<p>Since blocks can capture references to variables and <code>JSContext</code>s maintain strong references to all their variables, some care needs to be taken to avoid strong reference cycles. Avoid capturing your <code>JSContext</code> or any <code>JSValue</code>s inside a block. Instead, use <code>[JSContext currentContext]</code> to get the current context and pass any values you need as parameters.</p>

<h3><a id="user-content-jsexport-protocol" class="anchor" href="#jsexport-protocol" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>JSExport</code> Protocol</h3>

<p>Another way to use our custom objects from within JavaScript code is to add conformance to the <code>JSExport</code> protocol. Whatever properties, instance methods, and class methods we declare in our <code>JSExport</code>-inherited protocol will <em>automatically</em> be available to any JavaScript code. We'll see how in the following section.</p>

<h2><a id="user-content-javascriptcore-in-practice" class="anchor" href="#javascriptcore-in-practice" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>JavaScriptCore in Practice</h2>

<p>Let's build out an example that will use all these different techniques—we'll define a <code>Person</code> model that conforms to the <code>JSExport</code> sub-protocol <code>PersonJSExports</code>, then use JavaScript to create and populate instances from a JSON file. Who needs <code>NSJSONSerialization</code> when there's an entire JavaScript VM lying around?</p>

<h3><a id="user-content-1-personjsexports-and-person" class="anchor" href="#1-personjsexports-and-person" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1) <code>PersonJSExports</code> and <code>Person</code></h3>

<p>Our <code>Person</code> class implements the <code>PersonJSExports</code> protocol, which specifies what properties should be available in JavaScript. </p>

<blockquote>
<p>The <code>create...</code> class method is necessary because JavaScriptCore does <em>not</em> bridge initializers—we can't simply say <code>var person = new Person()</code> the way we would with a native JavaScript type.</p>
</blockquote>

<div class="highlight highlight-source-swift"><pre><span class="pl-c">// Custom protocol must be declared with `@objc`</span>
<span class="pl-k">@objc</span> <span class="pl-k">protocol</span> PersonJSExports <span class="pl-k">:</span> JSExport {
    <span class="pl-k">var</span> firstName: <span class="pl-c1">String</span> { <span class="pl-k">get</span> <span class="pl-k">set</span> }
    <span class="pl-k">var</span> lastName: <span class="pl-c1">String</span> { <span class="pl-k">get</span> <span class="pl-k">set</span> }
    <span class="pl-k">var</span> birthYear: NSNumber? { <span class="pl-k">get</span> <span class="pl-k">set</span> }

    <span class="pl-k">func</span> <span class="pl-en">getFullName</span>() <span class="pl-k">-&gt;</span> <span class="pl-c1">String</span>

    <span class="pl-c">/// create and return a new Person instance with `firstName` and `lastName`</span>
    <span class="pl-k">static</span> <span class="pl-k">func</span> <span class="pl-en">createWithFirstName</span>(firstName: <span class="pl-c1">String</span>, lastName: <span class="pl-c1">String</span>) <span class="pl-k">-&gt;</span> Person
}

<span class="pl-c">// Custom class must inherit from `NSObject`</span>
<span class="pl-k">@objc</span> <span class="pl-k">class</span> Person <span class="pl-k">:</span> NSObject, PersonJSExports {
    <span class="pl-c">// properties must be declared as `dynamic`</span>
    <span class="pl-k">dynamic</span> <span class="pl-k">var</span> firstName: <span class="pl-c1">String</span>
    <span class="pl-k">dynamic</span> <span class="pl-k">var</span> lastName: <span class="pl-c1">String</span>
    <span class="pl-k">dynamic</span> <span class="pl-k">var</span> birthYear: NSNumber?

    <span class="pl-k">init</span>(firstName: <span class="pl-c1">String</span>, lastName: <span class="pl-c1">String</span>) {
        <span class="pl-k">self</span><span class="pl-k">.</span>firstName <span class="pl-k">=</span> firstName
        <span class="pl-k">self</span><span class="pl-k">.</span>lastName <span class="pl-k">=</span> lastName
    }

    <span class="pl-k">class</span> <span class="pl-k">func</span> <span class="pl-en">createWithFirstName</span>(firstName: <span class="pl-c1">String</span>, lastName: <span class="pl-c1">String</span>) <span class="pl-k">-&gt;</span> Person {
        <span class="pl-k">return</span> Person(firstName: firstName, lastName: lastName)
    }

    <span class="pl-k">func</span> <span class="pl-en">getFullName</span>() <span class="pl-k">-&gt;</span> <span class="pl-c1">String</span> {
        <span class="pl-k">return</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pse">\(</span><span class="pl-s1">firstName</span><span class="pl-pse">)</span> <span class="pl-pse">\(</span><span class="pl-s1">lastName</span><span class="pl-pse">)</span><span class="pl-pds">"</span></span>
    }
}</pre></div>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// in Person.h -----------------</span>
<span class="pl-k">@class</span> Person;

<span class="pl-k">@protocol</span> <span class="pl-en">PersonJSExports</span> &lt;JSExport&gt;
    <span class="pl-k">@property</span> (<span class="pl-k">nonatomic</span>, <span class="pl-k">copy</span>) <span class="pl-c1">NSString</span> *firstName;
    <span class="pl-k">@property</span> (<span class="pl-k">nonatomic</span>, <span class="pl-k">copy</span>) <span class="pl-c1">NSString</span> *lastName;
    <span class="pl-k">@property</span> <span class="pl-c1">NSInteger</span> ageToday;

    - (<span class="pl-c1">NSString</span> *)getFullName;

    <span class="pl-c">// create and return a new Person instance with `firstName` and `lastName`</span>
    + (<span class="pl-k">instancetype</span>)createWithFirstName:(<span class="pl-c1">NSString</span> *)firstName lastName:(<span class="pl-c1">NSString</span> *)lastName;
<span class="pl-k">@end</span>

<span class="pl-k">@interface</span> <span class="pl-en">Person</span> : <span class="pl-e">NSObject</span> &lt;PersonJSExports&gt;
    <span class="pl-k">@property</span> (<span class="pl-k">nonatomic</span>, <span class="pl-k">copy</span>) <span class="pl-c1">NSString</span> *firstName;
    <span class="pl-k">@property</span> (<span class="pl-k">nonatomic</span>, <span class="pl-k">copy</span>) <span class="pl-c1">NSString</span> *lastName;
    <span class="pl-k">@property</span> <span class="pl-c1">NSInteger</span> ageToday;
<span class="pl-k">@end</span>

<span class="pl-c">// in Person.m -----------------</span>
<span class="pl-k">@implementation</span> <span class="pl-en">Person</span>
- (<span class="pl-c1">NSString</span> *)<span class="pl-en">getFullName</span> {
    <span class="pl-k">return</span> [<span class="pl-c1">NSString</span> <span class="pl-c1">stringWithFormat:</span><span class="pl-s"><span class="pl-pds">@"</span><span class="pl-c1">%@</span> <span class="pl-c1">%@</span><span class="pl-pds">"</span></span>, <span class="pl-v">self</span>.firstName, <span class="pl-v">self</span>.lastName];
}

+ (<span class="pl-k">instancetype</span>) <span class="pl-en">createWithFirstName</span><span class="pl-en">:</span>(<span class="pl-c1">NSString</span> *)<span class="pl-smi">firstName</span> <span class="pl-en">lastName</span><span class="pl-en">:</span>(<span class="pl-c1">NSString</span> *)<span class="pl-smi">lastName</span> {
    Person *person = [[Person <span class="pl-c1">alloc</span>] <span class="pl-c1">init</span>];
    person.<span class="pl-smi">firstName</span> = firstName;
    person.<span class="pl-smi">lastName</span> = lastName;
    <span class="pl-k">return</span> person;
}
<span class="pl-k">@end</span></pre></div>

<h3><a id="user-content-2-jscontext-configuration" class="anchor" href="#2-jscontext-configuration" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2) <code>JSContext</code> Configuration</h3>

<p>Before we can use the <code>Person</code> class we've created, we need to export it to the JavaScript environment. We'll also take this moment to import the <a href="http://mustache.github.io/">Mustache JS library</a>, which we'll use to apply templates to our <code>Person</code> objects later.</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-c">// export Person class</span>
context<span class="pl-k">.</span>setObject(Person<span class="pl-k">.</span><span class="pl-k">self</span>, forKeyedSubscript: <span class="pl-s"><span class="pl-pds">"</span>Person<span class="pl-pds">"</span></span>)

<span class="pl-c">// load Mustache.js</span>
<span class="pl-k">if</span> <span class="pl-k">let</span> mustacheJSString <span class="pl-k">=</span> <span class="pl-c1">String</span>(contentsOfFile:<span class="pl-k">...</span>, encoding:NSUTF8StringEncoding, error:<span class="pl-c1">nil</span>) {
    context<span class="pl-k">.</span>evaluateScript(mustacheJSString)
}</pre></div>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// export Person class</span>
context[<span class="pl-s"><span class="pl-pds">@"</span>Person<span class="pl-pds">"</span></span>] = [Person <span class="pl-c1">class</span>];

<span class="pl-c">// load Mustache.js</span>
<span class="pl-c1">NSString</span> *mustacheJSString = [<span class="pl-c1">NSString</span> <span class="pl-c1">stringWithContentsOfFile:</span>... <span class="pl-c1">encoding:</span>NSUTF8StringEncoding <span class="pl-c1">error:</span><span class="pl-c1">nil</span>];
[context <span class="pl-c1">evaluateScript:</span>mustacheJSString];</pre></div>

<h3><a id="user-content-3-javascript-data--processing" class="anchor" href="#3-javascript-data--processing" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>3) JavaScript Data &amp; Processing</h3>

<p>Here's a look at our simple JSON example and the code that will process it to create new <code>Person</code> instances. </p>

<blockquote>
<p>Note: JavaScriptCore translates Objective-C/Swift method names to be JavaScript-compatible. Since JavaScript doesn't have named parameters, any external parameter names are converted to camel-case and appended to the function name. In this example, the Objective-C method <code>createWithFirstName:lastName:</code> becomes <code>createWithFirstNameLastName()</code> in JavaScript.</p>
</blockquote>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> <span class="pl-en">loadPeopleFromJSON</span> <span class="pl-k">=</span> <span class="pl-k">function</span>(<span class="pl-smi">jsonString</span>) {
    <span class="pl-k">var</span> data <span class="pl-k">=</span> <span class="pl-c1">JSON</span>.<span class="pl-c1">parse</span>(jsonString);
    <span class="pl-k">var</span> people <span class="pl-k">=</span> [];
    <span class="pl-k">for</span> (i <span class="pl-k">=</span> <span class="pl-c1">0</span>; i <span class="pl-k">&lt;</span> <span class="pl-smi">data</span>.<span class="pl-c1">length</span>; i<span class="pl-k">++</span>) {
        <span class="pl-k">var</span> person <span class="pl-k">=</span> <span class="pl-smi">Person</span>.<span class="pl-en">createWithFirstNameLastName</span>(data[i].<span class="pl-smi">first</span>, data[i].<span class="pl-smi">last</span>);
        <span class="pl-smi">person</span>.<span class="pl-smi">birthYear</span> <span class="pl-k">=</span> data[i].<span class="pl-smi">year</span>;

        <span class="pl-smi">people</span>.<span class="pl-c1">push</span>(person);
    }
    <span class="pl-k">return</span> people;
}</pre></div>

<div class="highlight highlight-source-json"><pre>[
    { <span class="pl-s"><span class="pl-pds">"</span>first<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Grace<span class="pl-pds">"</span></span>,     <span class="pl-s"><span class="pl-pds">"</span>last<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Hopper<span class="pl-pds">"</span></span>,   <span class="pl-s"><span class="pl-pds">"</span>year<span class="pl-pds">"</span></span>: <span class="pl-c1">1906</span> },
    { <span class="pl-s"><span class="pl-pds">"</span>first<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Ada<span class="pl-pds">"</span></span>,       <span class="pl-s"><span class="pl-pds">"</span>last<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Lovelace<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>year<span class="pl-pds">"</span></span>: <span class="pl-c1">1815</span> },
    { <span class="pl-s"><span class="pl-pds">"</span>first<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Margaret<span class="pl-pds">"</span></span>,  <span class="pl-s"><span class="pl-pds">"</span>last<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Hamilton<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>year<span class="pl-pds">"</span></span>: <span class="pl-c1">1936</span> }
]</pre></div>

<h3><a id="user-content-4-tying-it-all-together" class="anchor" href="#4-tying-it-all-together" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>4) Tying It All Together</h3>

<p>All that remains is to load the JSON data, call into the <code>JSContext</code> to parse the data into an array of <code>Person</code> objects, and render each <code>Person</code> using a Mustache template:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-c">// get JSON string</span>
<span class="pl-k">let</span> peopleJSON <span class="pl-k">=</span> <span class="pl-k">try</span><span class="pl-k">!</span> <span class="pl-c1">String</span>(contentsOfFile: <span class="pl-k">...</span>, encoding: NSUTF8StringEncoding)

<span class="pl-c">// get load function</span>
<span class="pl-k">let</span> load <span class="pl-k">=</span> context<span class="pl-k">.</span>objectForKeyedSubscript(<span class="pl-s"><span class="pl-pds">"</span>loadPeopleFromJSON<span class="pl-pds">"</span></span>)
<span class="pl-c">// call with JSON and convert to an Array</span>
<span class="pl-k">if</span> <span class="pl-k">let</span> people <span class="pl-k">=</span> load<span class="pl-k">.</span>callWithArguments([peopleJSON])<span class="pl-k">.</span>toArray() <span class="pl-k">as?</span> [Person] {

    <span class="pl-c">// get rendering function and create template</span>
    <span class="pl-k">let</span> mustacheRender <span class="pl-k">=</span> context<span class="pl-k">.</span>objectForKeyedSubscript(<span class="pl-s"><span class="pl-pds">"</span>Mustache<span class="pl-pds">"</span></span>)<span class="pl-k">.</span>objectForKeyedSubscript(<span class="pl-s"><span class="pl-pds">"</span>render<span class="pl-pds">"</span></span>)
    <span class="pl-k">let</span> template <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>{% raw %}{{getFullName}}, born {{birthYear}}{% endraw %}<span class="pl-pds">"</span></span>

    <span class="pl-c">// loop through people and render Person object as string</span>
    <span class="pl-k">for</span> person <span class="pl-k">in</span> people {
        <span class="pl-c1">print</span>(mustacheRender<span class="pl-k">.</span>callWithArguments([template, person]))
    }
}

<span class="pl-c">// Output:</span>
<span class="pl-c">// Grace Hopper, born 1906</span>
<span class="pl-c">// Ada Lovelace, born 1815</span>
<span class="pl-c">// Margaret Hamilton, born 1936</span></pre></div>

<div class="highlight highlight-source-objc"><pre><span class="pl-c">// get JSON string</span>
<span class="pl-c1">NSString</span> *peopleJSON = [<span class="pl-c1">NSString</span> <span class="pl-c1">stringWithContentsOfFile:</span>... <span class="pl-c1">encoding:</span>NSUTF8StringEncoding <span class="pl-c1">error:</span><span class="pl-c1">nil</span>];

<span class="pl-c">// get load function</span>
JSValue *load = context[<span class="pl-s"><span class="pl-pds">@"</span>loadPeopleFromJSON<span class="pl-pds">"</span></span>];
<span class="pl-c">// call with JSON and convert to an NSArray</span>
JSValue *loadResult = [load <span class="pl-c1">callWithArguments:</span>@[peopleJSON]];
<span class="pl-c1">NSArray</span> *people = [loadResult <span class="pl-c1">toArray</span>];

<span class="pl-c">// get rendering function and create template</span>
JSValue *mustacheRender = context[<span class="pl-s"><span class="pl-pds">@"</span>Mustache<span class="pl-pds">"</span></span>][<span class="pl-s"><span class="pl-pds">@"</span>render<span class="pl-pds">"</span></span>];
<span class="pl-c1">NSString</span> *template = <span class="pl-s"><span class="pl-pds">@"</span>{<span class="pl-ii">%</span> raw <span class="pl-ii">%</span>}{{getFullName}}, born {{birthYear}}{<span class="pl-c1">% e</span>ndraw <span class="pl-ii">%</span>}<span class="pl-pds">"</span></span>;

<span class="pl-c">// loop through people and render Person object as string</span>
<span class="pl-k">for</span> (Person *person in people) {
   <span class="pl-c1">NSLog</span>(<span class="pl-s"><span class="pl-pds">@"</span><span class="pl-c1">%@</span><span class="pl-pds">"</span></span>, [mustacheRender <span class="pl-c1">callWithArguments:</span>@[template, person]]);
}

<span class="pl-c">// Output:</span>
<span class="pl-c">// Grace Hopper, born 1906</span>
<span class="pl-c">// Ada Lovelace, born 1815</span>
<span class="pl-c">// Margaret Hamilton, born 1936</span></pre></div>

<hr>

<p>How can you use JavaScript in your apps? JavaScript snippets could be the basis for user-defined plugins that ship alongside yours. If your product started out on the web, you may have existing infrastructure that can be used with only minor changes. Or if <em>you</em> started out as a programmer on the web, you might relish the chance to get back to your scripty roots. Whatever the case, JavaScriptCore is too well-built and powerful to ignore.</p>
</article></div>