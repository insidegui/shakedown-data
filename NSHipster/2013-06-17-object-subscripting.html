<div class="announce instapaper_body md" data-path="2013-06-17-object-subscripting.md" id="file"><article class="markdown-body entry-content" itemprop="text"><table data-table-type="yaml-metadata">
  <thead>
  <tr>
  <th>title</th>

  <th>author</th>

  <th>category</th>

  <th>excerpt</th>

  <th>status</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td><div>Object Subscripting</div></td>

  <td><div>Mattt Thompson</div></td>

  <td><div>Objective-C</div></td>

  <td><div>Xcode 4.4 quietly introduced a syntactic revolution to Objective-C. Like all revolutions, however, its origins and agitators require some effort to trace.</div></td>

  <td><div><table>
  <thead>
  <tr>
  <th>swift</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td><div>n/a</div></td>
  </tr>
  </tbody>
</table></div></td>
  </tr>
  </tbody>
</table>

<p>Xcode 4.4 quietly introduced a syntactic revolution to Objective-C. Like all revolutions, however, its origins and agitators require some effort to trace: Xcode 4.4 shipped with Apple LLVM Compiler 4.0, which incorporated changes effective in the Clang front-end as of version 3.1.</p>

<blockquote>
<p>For the uninitiated, <a href="http://clang.llvm.org/index.html">Clang</a> is the open source C language family front end to the <a href="http://www.llvm.org">LLVM</a> compiler. Clang is responsible for all of the killer language features in Objective-C going back a few years, such as "Build &amp; Analyze", ARC, blocks, and a nearly 3× performance boost when compiling over GCC.</p>
</blockquote>

<p>Clang 3.1 added three features to Objective-C whose aesthetic &amp; cosmetic impact is comparable to the changes brought about in Objective-C 2.0: <a href="http://clang.llvm.org/docs/ObjectiveCLiterals.html#nsnumber-literals"><code>NSNumber</code> Literals</a>, <a href="http://clang.llvm.org/docs/ObjectiveCLiterals.html#container-literals">Collection Literals</a>, and <a href="http://clang.llvm.org/docs/ObjectiveCLiterals.html#object-subscripting">Object Subscripting</a>.</p>

<p>In a single Xcode release, Objective-C went from this:</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c1">NSDictionary</span> *dictionary = [<span class="pl-c1">NSDictionary</span> <span class="pl-c1">dictionaryWithObject:</span>[<span class="pl-c1">NSNumber</span> <span class="pl-c1">numberWithInteger:</span><span class="pl-c1">42</span>] <span class="pl-c1">forKey:</span><span class="pl-s"><span class="pl-pds">@"</span>foo<span class="pl-pds">"</span></span>];
<span class="pl-c1">id</span> value = [dictionary <span class="pl-c1">objectForKey:</span><span class="pl-s"><span class="pl-pds">@"</span>foo<span class="pl-pds">"</span></span>];</pre></div>

<p>...to this:</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c1">NSDictionary</span> *dictionary = @{<span class="pl-s"><span class="pl-pds">@"</span>foo<span class="pl-pds">"</span></span>: @<span class="pl-c1">42</span>};
<span class="pl-c1">id</span> value = dictionary[<span class="pl-s"><span class="pl-pds">@"</span>foo<span class="pl-pds">"</span></span>];</pre></div>

<p>Concision is the essence of clarity.</p>

<p>Shorter code means typing less, but it also means understanding more. Even a sprinkle of syntactic sugar can be enough to transform a language, and unlock new design patterns.</p>

<p>Collection literals become preferable to property lists for configuration.<br>
Single-element array parameters become more acceptable.<br>
APIs requiring boxed numeric values become more palatable.<br></p>

<p>However, what remains relatively under-utilized even now—a year after the these language features were added—is object subscripting. Perhaps after reading the rest of this article, though, you'll help to change this.</p>

<hr>

<p>Elements in a C array are laid out contiguously in memory, and are referenced by the address of the first element. To get the value at a particular index, one would offset this address by the size of an array element, multiplied by the desired index. This pointer arithmetic is provided by the <code>[]</code> operator.</p>

<p>Over time, scripting languages began to take greater liberties with this familiar convention, expanding its role to get &amp; set values in arrays, as well as hashes and objects.</p>

<p>With Clang 3.1, everything has come full-circle: what began as a C operator and co-opted by scripting languages, has now been rolled back into Objective-C. And like the aforementioned scripting languages of yore, the <code>[]</code> subscripting operator in Objective-C has been similarly overloaded to handle both integer-indexed and object-keyed accessors.</p>

<div class="highlight highlight-source-objc"><pre>dictionary[<span class="pl-s"><span class="pl-pds">@"</span>foo<span class="pl-pds">"</span></span>] = @<span class="pl-c1">42</span>;
array[<span class="pl-c1">0</span>] = <span class="pl-s"><span class="pl-pds">@"</span>bar<span class="pl-pds">"</span></span></pre></div>

<blockquote>
<p>If Objective-C is a superset of C, how can Object Subscripting overload the <code>[]</code> C operator? The modern Objective-C runtime prohibits pointer arithmetic on objects, making this semantic pivot possible.</p>
</blockquote>

<p>Where this really becomes interesting is when you extend your own classes with subscripting support:</p>

<h3><a id="user-content-custom-indexed-subscripting" class="anchor" href="#custom-indexed-subscripting" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Indexed Subscripting</h3>

<p>To add custom-indexed subscripting support to your class, simply declare and implement the following methods:</p>

<div class="highlight highlight-source-objc"><pre>- (<span class="pl-c1">id</span>)objectAtIndexedSubscript:(*IndexType*)idx;
- (<span class="pl-k">void</span>)setObject:(<span class="pl-c1">id</span>)obj atIndexedSubscript:(*IndexType*)idx;</pre></div>

<p><code>*IndexType*</code> can be any integral type, such as <code>char</code>, <code>int</code>, or <code>NSUInteger</code>, as used by <code>NSArray</code>.</p>

<h3><a id="user-content-custom-keyed-subscripting" class="anchor" href="#custom-keyed-subscripting" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Keyed Subscripting</h3>

<p>Similarly, custom-keyed subscripting can be added to your class by declaring and implementing these methods:</p>

<div class="highlight highlight-source-objc"><pre>- (<span class="pl-c1">id</span>)objectForKeyedSubscript:(*KeyType*)key;
- (<span class="pl-k">void</span>)setObject:(<span class="pl-c1">id</span>)obj forKeyedSubscript:(*KeyType*)key;</pre></div>

<p><code>*KeyType*</code> can be any Objective-C object pointer type.</p>

<blockquote>
<p>In fact, for non-general-purpose collections, indexed and keyed subscripting can get and set <em>any</em> Objective-C object pointer type, not just <code>id</code>. </p>
</blockquote>

<h2><a id="user-content-custom-subscripting-as-dsl" class="anchor" href="#custom-subscripting-as-dsl" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom Subscripting as DSL</h2>

<p>The whole point in describing all of this is to encourage unconventional thinking about this whole language feature. At the moment, a majority of custom subscripting in classes is used as a convenience accessor to a private collection class. But there's nothing to stop you from, for instance, doing this:</p>

<div class="highlight highlight-source-objc"><pre>routes[<span class="pl-s"><span class="pl-pds">@"</span>GET /users/:id<span class="pl-pds">"</span></span>] = ^(<span class="pl-c1">NSNumber</span> *userID){
  <span class="pl-c">// ...</span>
}</pre></div>

<p>...or this:</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c1">id</span> piece = chessBoard[<span class="pl-s"><span class="pl-pds">@"</span>E1<span class="pl-pds">"</span></span>];</pre></div>

<p>...or this:</p>

<div class="highlight highlight-source-objc"><pre><span class="pl-c1">NSArray</span> *results = managedObjectContext[<span class="pl-s"><span class="pl-pds">@"</span>Product WHERE stock &gt; 20<span class="pl-pds">"</span></span>];</pre></div>

<p>Because of how flexible and concise subscripting is, it is extremely well-purposed for creating <a href="http://en.wikipedia.org/wiki/Domain-specific_language">DSL</a>s. When defining custom subscripting methods on your own class, there are no restrictions on how they are implemented. You can use this syntax to provide a shorthand for defining application routes, search queries, compound property accessors, or plain-old KVO.</p>

<hr>

<p>This is, of course, dangerous thinking. Subscripting isn't your new bicycle. It isn't a giant hammer. Hell, <em>it isn't even a giant screwdriver!</em> If there is one thing Object Subscripting DSLs are, it's trouble. Here be dragons.</p>

<p>That said, it does open up some interesting opportunities to bend syntactic conventions to useful ends.</p>
</article></div>