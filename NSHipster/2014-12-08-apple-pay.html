<div class="announce instapaper_body md" data-path="2014-12-08-apple-pay.md" id="file"><article class="markdown-body entry-content" itemprop="text"><table data-table-type="yaml-metadata">
  <thead>
  <tr>
  <th>title</th>

  <th>author</th>

  <th>category</th>

  <th>excerpt</th>

  <th>status</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td><div>Pay</div></td>

  <td><div>Jack Flintermann</div></td>

  <td><div></div></td>

  <td><div>There's a unique brand of modern angst that manifests the moment you decide to buy something online. While there's no English word for it, it translates roughly to "Where is my credit card? What is its number? How badly do I actually want this thing, anyway?"</div></td>

  <td><div><table>
  <thead>
  <tr>
  <th>swift</th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td><div>1.0</div></td>
  </tr>
  </tbody>
</table></div></td>
  </tr>
  </tbody>
</table>

<p>There's a unique brand of modern angst that manifests the moment you decide to buy something online. While there's no English word for it, it translates roughly to "Where is my credit card? What is its number? How badly do I actually want this thing, anyway?".</p>

<p>When you're on an iOS device, this ennui intensifies: there's a good chance you don't have your card with you, and holding your credit card and typing on your phone simultaneously is a feat best left to gymnasts and astronauts. (I'm sort of joking, but also willing to bet Apple has measured this in a lab somewhere.)</p>

<p>And if you're a developer accepting credit card payments in your app, this unfortunate phenomenon is directly correlated to lost revenue.</p>

<p><a href="http://apple.com/apple-pay">Apple Pay</a> changes all this. Though a lot of the attention around its launch has focused on physical payments in stores (where customers can use their iPhone to pay at NFC-enabled payment terminals), there's an equally large opportunity for iOS developers to improve the checkout experience in their apps.</p>

<blockquote>
<p>Just a reminder: if you're selling digital goods or virtual currencies in your app, you should use In-App Purchases—not Apple Pay—to sell your content (See <a href="https://developer.apple.com/app-store/review/guidelines/#purchasing-currencies">section 11.2</a> of the App Store Review Guidelines). You can use Apple Pay for selling physical goods and services.</p>
</blockquote>

<hr>

<h2><a id="user-content-obtaining-an-apple-merchant-id" class="anchor" href="#obtaining-an-apple-merchant-id" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Obtaining an Apple Merchant ID</h2>

<p>You'll have to register an Apple Merchant ID before testing anything out. Before doing this, you should choose a payment provider to actually handle your credit card processing. Apple provides a list of recommended ones at their <a href="http://developer.apple.com/apple-pay">Apple Pay Developer Page</a> (disclosure: I work for <a href="https://stripe.com/">Stripe</a>, one of the recommended companies, but the code in this article doesn't depend on you choosing any specific provider). While your provider should have a specific guide for how to get set up using Apple Pay with their platform, the process looks like this:</p>

<ul>
<li>Head to the <code>Certificates, Identifiers, and Profiles</code> section of the Apple Developer center and <a href="https://developer.apple.com/account/ios/identifiers/merchant/merchantCreate.action">create a new merchant ID</a>.</li>
<li>Next, <a href="https://developer.apple.com/account/ios/certificate/certificateCreate.action">head to the Certificates section</a> and create a new Apple Pay Certificate. This involves uploading a Certificate Signing Request (CSR) to Apple. When you're signing up for a payment processor, they'll typically give you a CSR to use. You can use a CSR that you generate yourself to follow along with this guide, but your payment processor won't be able to decrypt payments made with it and you'll need to redo it later.</li>
<li>In Xcode, go to the "Capabilities" section of your project settings and turn "Apple Pay" to on. You may have to select the merchant ID you created earlier from the list provided.</li>
</ul>

<h2><a id="user-content-making-your-first-charge" class="anchor" href="#making-your-first-charge" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Making Your First Charge</h2>

<blockquote>
<p>Apple Pay will only work on an iOS device capable of using Apple Pay (e.g. iPhone 6/6+, iPad Mini 3, iPad Air 2). In addition, you have to have successfully added the Apple Pay entitlement (described in "Obtaining an Apple Merchant ID") in order to test it in your app. If you'd like to approximate its behavior on the simulator, you can find a testing library that mimics its functionality (with test credit card details) at <a href="https://github.com/stripe/ApplePayStubs">https://github.com/stripe/ApplePayStubs</a>.</p>
</blockquote>

<p>Once you're up and running with a merchant account, getting started with Apple Pay is really straightforward. When it's time to check out, you'll first need to see if Apple Pay is supported on the device you're running and your customer has added any cards to Passbook:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> paymentNetworks <span class="pl-k">=</span> [PKPaymentNetworkAmex, PKPaymentNetworkMasterCard, PKPaymentNetworkVisa]
<span class="pl-k">if</span> PKPaymentAuthorizationViewController<span class="pl-k">.</span>canMakePaymentsUsingNetworks(paymentNetworks) {
    <span class="pl-c">// Pay is available!</span>
} <span class="pl-k">else</span> {
    <span class="pl-c">// Show your own credit card form.</span>
}</pre></div>

<p>Assuming Apple Pay is available, the next step is to assemble a <code>PKPaymentRequest</code>. This object describes the charge you're requesting from your customer. If you're requesting payment in the U.S. (reasonable, as Apple Pay is currently US-only), here's some default options you'll need to set that'll likely stay constant:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> request <span class="pl-k">=</span> PKPaymentRequest()
request<span class="pl-k">.</span>supportedNetworks <span class="pl-k">=</span> [PKPaymentNetworkAmex, PKPaymentNetworkMasterCard, PKPaymentNetworkVisa]
request<span class="pl-k">.</span>countryCode <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>US<span class="pl-pds">"</span></span>
request<span class="pl-k">.</span>currencyCode <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>USD<span class="pl-pds">"</span></span>
request<span class="pl-k">.</span>merchantIdentifier <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>&lt;#Replace me with your Apple Merchant ID#&gt;<span class="pl-pds">"</span></span>
request<span class="pl-k">.</span>merchantCapabilities <span class="pl-k">=</span> <span class="pl-k">.</span>Capability3DS</pre></div>

<p>Next, describe the things the customer is actually buying with the <code>paymentSummaryItems</code> property. This takes an array of <code>PKPaymentSummaryItem</code>s, which have a <code>label</code> and <code>amount</code>. They're analogous to line items on a receipt (which we'll see momentarily).</p>

<p><a href="%7B%7B%20site.asseturl%20%7D%7D/apple-pay-payment-authorization.png" target="_blank"><img src="%7B%7B%20site.asseturl%20%7D%7D/apple-pay-payment-authorization.png" alt="Payment Authorization" style="max-width:100%;"></a></p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> wax <span class="pl-k">=</span> PKPaymentSummaryItem(label: <span class="pl-s"><span class="pl-pds">"</span>Mustache Wax<span class="pl-pds">"</span></span>, amount: NSDecimalNumber(string: <span class="pl-s"><span class="pl-pds">"</span>10.00<span class="pl-pds">"</span></span>))
<span class="pl-k">let</span> discount <span class="pl-k">=</span> PKPaymentSummaryItem(label: <span class="pl-s"><span class="pl-pds">"</span>Discount<span class="pl-pds">"</span></span>, amount: NSDecimalNumber(string: <span class="pl-s"><span class="pl-pds">"</span>-1.00<span class="pl-pds">"</span></span>))

<span class="pl-k">let</span> totalAmount <span class="pl-k">=</span> wax<span class="pl-k">.</span>amount<span class="pl-k">.</span>decimalNumberByAdding(discount<span class="pl-k">.</span>amount)
                            <span class="pl-k">.</span>decimalNumberByAdding(shipping<span class="pl-k">.</span>amount)
<span class="pl-k">let</span> total <span class="pl-k">=</span> PKPaymentSummaryItem(label: <span class="pl-s"><span class="pl-pds">"</span>NSHipster<span class="pl-pds">"</span></span>, amount: totalAmount)

request<span class="pl-k">.</span>paymentSummaryItems <span class="pl-k">=</span> [wax, discount, shipping, total]</pre></div>

<p>Note that you can specify zero or negative amounts here to apply coupons or communicate other information. However, the total amount requested must be greater than zero. You'll note we use a <code>PKShippingMethod</code> (inherits from <code>PKPaymentSummaryItem</code>) to describe our shipping item. More on this later.</p>

<p>Next, to display the actual payment sheet to the customer, we create an instance of <code>PKPaymentAuthorizationViewController</code> with our <code>PKPaymentRequest</code> and present it. (Assume for this example that all this code is inside a <code>UIViewController</code> that will sit behind the payment screen).</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">let</span> viewController <span class="pl-k">=</span> PKPaymentAuthorizationViewController(paymentRequest: request)
viewController<span class="pl-k">.</span>delegate <span class="pl-k">=</span> <span class="pl-k">self</span>
presentViewController(viewController, animated: <span class="pl-c1">true</span>, completion: <span class="pl-c1">nil</span>)</pre></div>

<p>A few style nits to be aware of:</p>

<ul>
<li>The view controller doesn't fully obscure the screen (in this case the blue background is part of our application). You can update the background view controller while the <code>PKPaymentAuthorizationViewController</code> is visible if you want.</li>
<li>All text is automatically capitalized.</li>
<li>The final line item is separated from the rest, and is intended to display the total amount you're charging. The label will be prepended with the word "PAY", so it usually makes sense to put your company name for the payment summary item's <code>label</code>.</li>
<li>The entire UI is presented via a Remote View Controller. This means that outside the <code>PKPaymentRequest</code> you give it, it's impossible to otherwise style or modify the contents of this view.</li>
</ul>

<h2><a id="user-content-pkpaymentauthorizationviewcontrollerdelegate" class="anchor" href="#pkpaymentauthorizationviewcontrollerdelegate" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>PKPaymentAuthorizationViewControllerDelegate</h2>

<p>In order to actually handle the payment information returned by the <code>PKPaymentAuthorizationViewController</code>, you need to implement the <code>PKPaymentAuthorizationViewControllerDelegate</code> protocol. This has 2 required methods, <code>-(void)paymentAuthorizationViewController:didAuthorizePayment:completion:</code> and <code>-(void)paymentAuthorizationViewControllerDidFinish:</code>.</p>

<p>To understand how each of these components work, let's check out a timeline of how an Apple Pay purchase works:</p>

<ul>
<li>You present a <code>PKPaymentAuthorizationViewController</code> as described above.</li>
<li>The customer approves the purchase using Touch ID (or, if that fails 3 times, by entering their passcode).</li>
<li>The thumbprint icon turns into a spinner, with the label "Processing"</li>
<li>Your delegate receives the <code>paymentAuthorizationViewController:didAuthorizePayment:completion:</code> callback.</li>
<li>Your application communicates asynchronously with your payment processor and website backend to actually make a charge with those payment details. Once this complete, you invoke the <code>completion</code> handler that you're given as a parameter with either <code>PKPaymentAuthorizationStatus.Success</code> or <code>PKPaymentAuthorizationStatus.Failure</code> depending on the result.</li>
<li>The <code>PKPaymentAuthorizationViewController</code> spinner animates into a success or failure icon. If successful, a notification will arrive from PassBook indicating a charge on the customer's credit card.</li>
<li>Your delegate receives the <code>paymentAuthorizationViewControllerDidFinish:</code> callback. It is then responsible for calling <code>dismissViewControllerAnimated:completion</code> to dismiss the payment screen.</li>
</ul>

<p><a href="%7B%7B%20site.asseturl%20%7D%7D/apple-pay-indicators.png" target="_blank"><img src="%7B%7B%20site.asseturl%20%7D%7D/apple-pay-indicators.png" alt="Status Indicator" style="max-width:100%;"></a></p>

<p>Concretely, this comes out looking like this:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-c">// MARK: - PKPaymentAuthorizationViewControllerDelegate</span>

<span class="pl-k">func</span> <span class="pl-en">paymentAuthorizationViewController</span>(controller: PKPaymentAuthorizationViewController<span class="pl-k">!</span>, <span class="pl-en">didAuthorizePayment</span> <span class="pl-smi">payment</span>: PKPayment<span class="pl-k">!</span>, completion: ((PKPaymentAuthorizationStatus) <span class="pl-k">-&gt;</span> <span class="pl-c1">Void</span>)!) {
    <span class="pl-c">// Use your payment processor's SDK to finish charging your customer.</span>
    <span class="pl-c">// When this is done, call completion(PKPaymentAuthorizationStatus.Success)</span>
}

<span class="pl-k">func</span> <span class="pl-en">paymentAuthorizationViewControllerDidFinish</span>(controller: PKPaymentAuthorizationViewController<span class="pl-k">!</span>) {
    dismissViewControllerAnimated(<span class="pl-c1">true</span>, completion: <span class="pl-c1">nil</span>)
}</pre></div>

<p>Here, the <code>processPayment:payment completion:</code> method is your own code, and would leverage your payment processor's SDK to finish the charge.</p>

<h2><a id="user-content-dynamic-shipping-methods-and-pricing" class="anchor" href="#dynamic-shipping-methods-and-pricing" aria-hidden="true"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dynamic Shipping Methods and Pricing</h2>

<p>If you're using Apple Pay to let your customer buy physical goods, you might want to offer them different shipping options. You can do this by setting the <code>shippingMethods</code> property on <code>PKPaymentRequest</code>. Then, you can respond to your customer's selection by implementing the optional <code>PKPaymentAuthorizationViewControllerDelegate</code> method, <code>paymentAuthorizationViewController:didSelectShippingMethod:completion:</code>. This method follows a similar pattern to the <code>didAuthorizePayment</code> method described above, where you're allowed to do asynchronous work and then call a callback with an updated array of <code>PKPaymentSummaryItem</code>s that includes the customer's desired shipping method. (Remember from earlier that <code>PKShippingMethod</code> inherits from <code>PKPaymentSummaryItem</code>? This is really helpful here!)</p>

<p>Here's a modified version of our earlier example, implemented as a computed property on the view controller and helper function:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">var</span> paymentRequest: PKPaymentRequest {
    <span class="pl-k">let</span> request <span class="pl-k">=</span> <span class="pl-k">...</span> <span class="pl-c">// initialize as before</span>

    <span class="pl-k">let</span> freeShipping <span class="pl-k">=</span> PKShippingMethod(label: <span class="pl-s"><span class="pl-pds">"</span>Free Shipping<span class="pl-pds">"</span></span>, amount: NSDecimalNumber(string: <span class="pl-s"><span class="pl-pds">"</span>0<span class="pl-pds">"</span></span>))
    freeShipping<span class="pl-k">.</span>identifier <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>freeshipping<span class="pl-pds">"</span></span>
    freeShipping<span class="pl-k">.</span>detail <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Arrives in 6-8 weeks<span class="pl-pds">"</span></span>

    <span class="pl-k">let</span> expressShipping <span class="pl-k">=</span> PKShippingMethod(label: <span class="pl-s"><span class="pl-pds">"</span>Express Shipping<span class="pl-pds">"</span></span>, amount: NSDecimalNumber(string: <span class="pl-s"><span class="pl-pds">"</span>10.00<span class="pl-pds">"</span></span>))
    expressShipping<span class="pl-k">.</span>identifier <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>expressshipping<span class="pl-pds">"</span></span>
    expressShipping<span class="pl-k">.</span>detail <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Arrives in 2-3 days<span class="pl-pds">"</span></span>

    request<span class="pl-k">.</span>shippingMethods <span class="pl-k">=</span> [freeShipping, expressShipping]
    request<span class="pl-k">.</span>paymentSummaryItems <span class="pl-k">=</span> paymentSummaryItemsForShippingMethod(freeShipping)

    <span class="pl-k">return</span> request
}

<span class="pl-k">func</span> <span class="pl-en">paymentSummaryItemsForShippingMethod</span>(shipping: PKShippingMethod) <span class="pl-k">-&gt;</span> ([PKPaymentSummaryItem]) {
    <span class="pl-k">let</span> wax <span class="pl-k">=</span> PKPaymentSummaryItem(label: <span class="pl-s"><span class="pl-pds">"</span>Mustache Wax<span class="pl-pds">"</span></span>, amount: NSDecimalNumber(string: <span class="pl-s"><span class="pl-pds">"</span>10.00<span class="pl-pds">"</span></span>))
    <span class="pl-k">let</span> discount <span class="pl-k">=</span> PKPaymentSummaryItem(label: <span class="pl-s"><span class="pl-pds">"</span>Discount<span class="pl-pds">"</span></span>, amount: NSDecimalNumber(string: <span class="pl-s"><span class="pl-pds">"</span>-1.00<span class="pl-pds">"</span></span>))

    <span class="pl-k">let</span> totalAmount <span class="pl-k">=</span> wax<span class="pl-k">.</span>amount<span class="pl-k">.</span>decimalNumberByAdding(discount<span class="pl-k">.</span>amount)
                                <span class="pl-k">.</span>decimalNumberByAdding(shipping<span class="pl-k">.</span>amount)
    <span class="pl-k">let</span> total <span class="pl-k">=</span> PKPaymentSummaryItem(label: <span class="pl-s"><span class="pl-pds">"</span>NSHipster<span class="pl-pds">"</span></span>, amount: totalAmount)

    <span class="pl-k">return</span> [wax, discount, shipping, total]
}

<span class="pl-c">// MARK: - PKPaymentAuthorizationViewControllerDelegate</span>

<span class="pl-k">func</span> <span class="pl-en">paymentAuthorizationViewController</span>(controller: PKPaymentAuthorizationViewController<span class="pl-k">!</span>, <span class="pl-en">didSelectShippingMethod</span> <span class="pl-smi">shippingMethod</span>: PKShippingMethod<span class="pl-k">!</span>, completion: ((PKPaymentAuthorizationStatus, [<span class="pl-c1">AnyObject</span>]<span class="pl-k">!</span>) <span class="pl-k">-&gt;</span> <span class="pl-c1">Void</span>)!) {
    completion(PKPaymentAuthorizationStatus<span class="pl-k">.</span>Success, paymentSummaryItemsForShippingMethod(shippingMethod))
}</pre></div>

<p>In this example, the customer will get the option to choose either free or express shipping—and the price they're quoted will adjust accordingly as they change their selection.</p>

<p><em>But wait, there's more!</em></p>

<p>Instead of having to provide a bunch of flat-rate shipping options, you can let your customer choose their shipping address and then calculate shipping rates dynamically based on that. To do that, you'll first need to set the <code>requiredShippingAddressFields</code> property on your <code>PKPaymentRequest</code>. This can represent any combination of <code>PKAddressField.Email</code> , .<code>PhoneNumber</code>, and .<code>PostalAddress</code>.</p>

<blockquote>
<p>Alternatively, if you don't need the user's full mailing address but need to collect some contact information (like an email address to send receipts to), this is a good way to do it.</p>
</blockquote>

<p>When this field is set, a new "Shipping Address" row appears in the payment UI that allows the customer to choose one of their saved addresses. Every time they choose one, the (aptly named) <code>paymentAuthorizationViewController:didSelectShippingAddress:completion:</code> message will be sent to your <code>PKPaymentAuthorizationViewControllerDelegate</code>.</p>

<p>Here, you should calculate the shipping rates for the selected address and then call the <code>completion</code> callback with 3 arguments:</p>

<ol>
<li>The result of the call

<ul>
<li><code>PKPaymentAuthorizationStatus.Success</code> if successful</li>
<li>`<code>PKPaymentAuthorizationStatus.</code>Failure` if a connection error occurs</li>
<li><code>.InvalidShippingPostalAddress</code> if the API returns an empty array (i.e. shipping to that address is impossible).</li>
</ul></li>
<li>An array of <code>PKShippingMethod</code>s representing the customer's available shipping options</li>
<li>A new array of <code>PKPaymentSummaryItem</code>s that contains one of the shipping methods</li>
</ol>

<p>I've set up a really simple web backend that queries the EasyPost API for shipping rates to a given address. The source is available at <a href="https://github.com/jflinter/example-shipping-api">https://github.com/jflinter/example-shipping-api</a>.</p>

<p>Here's a function to query it, using <a href="http://nshipster.com/alamofire/">Alamofire</a>:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">import</span> <span class="pl-c1">AddressBook</span>
<span class="pl-k">import</span> <span class="pl-c1">PassKit</span>
<span class="pl-k">import</span> <span class="pl-c1">Alamofire</span>

<span class="pl-k">func</span> <span class="pl-en">addressesForRecord</span>(record: ABRecord) <span class="pl-k">-&gt;</span> [[<span class="pl-c1">String</span>: <span class="pl-c1">String</span>]] {
    <span class="pl-k">var</span> addresses: [[<span class="pl-c1">String</span>: <span class="pl-c1">String</span>]] <span class="pl-k">=</span> []
    <span class="pl-k">let</span> values: ABMultiValue <span class="pl-k">=</span> ABRecordCopyValue(record, kABPersonAddressProperty)<span class="pl-k">.</span><span class="pl-c1">takeRetainedValue</span>()
    <span class="pl-k">for</span> index <span class="pl-k">in</span> <span class="pl-c1">0</span><span class="pl-k">..&lt;</span>ABMultiValueGetCount(values) {
        <span class="pl-k">if</span> <span class="pl-k">let</span> address <span class="pl-k">=</span> ABMultiValueCopyValueAtIndex(values, index)<span class="pl-k">.</span><span class="pl-c1">takeRetainedValue</span>() <span class="pl-k">as?</span> [<span class="pl-c1">String</span>: <span class="pl-c1">String</span>] {
            addresses<span class="pl-k">.</span>append(address)
        }
    }

    <span class="pl-k">return</span> addresses
}

<span class="pl-k">func</span> <span class="pl-en">fetchShippingMethodsForAddress</span>(address: [<span class="pl-c1">String</span>: <span class="pl-c1">String</span>], completion: ([PKShippingMethod]?) <span class="pl-k">-&gt;</span> <span class="pl-c1">Void</span>) {
    <span class="pl-k">let</span> parameters <span class="pl-k">=</span> [
        <span class="pl-s"><span class="pl-pds">"</span>street<span class="pl-pds">"</span></span>: address[kABPersonAddressStreetKey] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>city<span class="pl-pds">"</span></span>: address[kABPersonAddressCityKey] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>state<span class="pl-pds">"</span></span>: address[kABPersonAddressStateKey] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>zip<span class="pl-pds">"</span></span>: address[kABPersonAddressZIPKey] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
        <span class="pl-s"><span class="pl-pds">"</span>country<span class="pl-pds">"</span></span>: address[kABPersonAddressCountryKey] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>
    ]

    Alamofire<span class="pl-k">.</span>request(<span class="pl-k">.</span>GET, <span class="pl-s"><span class="pl-pds">"</span>http://example.com<span class="pl-pds">"</span></span>, parameters: parameters)
             <span class="pl-k">.</span>responseJSON { (_, _, JSON, _) <span class="pl-k">in</span>
                <span class="pl-k">if</span> <span class="pl-k">let</span> rates <span class="pl-k">=</span> JSON <span class="pl-k">as?</span> [[<span class="pl-c1">String</span>: <span class="pl-c1">String</span>]] {
                    <span class="pl-k">let</span> shippingMethods <span class="pl-k">=</span> map(rates) { (rate) <span class="pl-k">-&gt;</span> PKShippingMethod <span class="pl-k">in</span>
                        <span class="pl-k">let</span> identifier <span class="pl-k">=</span> rate[<span class="pl-s"><span class="pl-pds">"</span>id<span class="pl-pds">"</span></span>]
                        <span class="pl-k">let</span> carrier <span class="pl-k">=</span> rate[<span class="pl-s"><span class="pl-pds">"</span>carrier<span class="pl-pds">"</span></span>] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span>Unknown Carrier<span class="pl-pds">"</span></span>
                        <span class="pl-k">let</span> service <span class="pl-k">=</span> rate[<span class="pl-s"><span class="pl-pds">"</span>service<span class="pl-pds">"</span></span>] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span>Unknown Service<span class="pl-pds">"</span></span>
                        <span class="pl-k">let</span> amount <span class="pl-k">=</span> NSDecimalNumber(string: rate[<span class="pl-s"><span class="pl-pds">"</span>amount<span class="pl-pds">"</span></span>])
                        <span class="pl-k">let</span> arrival <span class="pl-k">=</span> rate[<span class="pl-s"><span class="pl-pds">"</span>formatted_arrival_date<span class="pl-pds">"</span></span>] <span class="pl-k">??</span> <span class="pl-s"><span class="pl-pds">"</span>Unknown Arrival<span class="pl-pds">"</span></span>

                        <span class="pl-k">let</span> shippingMethod <span class="pl-k">=</span> PKShippingMethod(label: <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pse">\(</span><span class="pl-s1">carrier</span><span class="pl-pse">)</span> <span class="pl-pse">\(</span><span class="pl-s1">service</span><span class="pl-pse">)</span><span class="pl-pds">"</span></span>, amount: amount)
                        shippingMethod<span class="pl-k">.</span>identifier <span class="pl-k">=</span> identifier
                        shippingMethod<span class="pl-k">.</span>detail <span class="pl-k">=</span> arrival

                        <span class="pl-k">return</span> shippingMethod
                    }
                }
             }
}</pre></div>

<p>With this, it's simple to implement <code>PKPaymentAuthorizationViewControllerDelegate</code>:</p>

<div class="highlight highlight-source-swift"><pre><span class="pl-k">func</span> <span class="pl-en">paymentAuthorizationViewController</span>(controller: PKPaymentAuthorizationViewController<span class="pl-k">!</span>, <span class="pl-en">didSelectShippingAddress</span> <span class="pl-smi">record</span>: ABRecord<span class="pl-k">!</span>, completion: ((PKPaymentAuthorizationStatus, [<span class="pl-c1">AnyObject</span>]<span class="pl-k">!</span>, [<span class="pl-c1">AnyObject</span>]<span class="pl-k">!</span>) <span class="pl-k">-&gt;</span> <span class="pl-c1">Void</span>)!) {
    <span class="pl-k">if</span> <span class="pl-k">let</span> address <span class="pl-k">=</span> addressesForRecord(record)<span class="pl-k">.</span><span class="pl-c1">first</span> {
        fetchShippingMethodsForAddress(address) { (shippingMethods) <span class="pl-k">in</span>
            <span class="pl-k">switch</span> shippingMethods?<span class="pl-k">.</span><span class="pl-c1">count</span> {
            <span class="pl-k">case</span> <span class="pl-k">.</span>None:
                completion(PKPaymentAuthorizationStatus<span class="pl-k">.</span>Failure, <span class="pl-c1">nil</span>, <span class="pl-c1">nil</span>)
            <span class="pl-k">case</span> <span class="pl-k">.</span>Some(<span class="pl-c1">0</span>):
                completion(PKPaymentAuthorizationStatus<span class="pl-k">.</span>InvalidShippingPostalAddress, <span class="pl-c1">nil</span>, <span class="pl-c1">nil</span>)
            <span class="pl-k">default</span>:
                completion(PKPaymentAuthorizationStatus<span class="pl-k">.</span>Success, shippingMethods, <span class="pl-k">self</span><span class="pl-k">.</span>paymentSummaryItemsForShippingMethod(shippingMethods<span class="pl-k">!.</span><span class="pl-c1">first</span><span class="pl-k">!</span>))
            }
        }
    } <span class="pl-k">else</span> {
        completion(PKPaymentAuthorizationStatus<span class="pl-k">.</span>Failure, <span class="pl-c1">nil</span>, <span class="pl-c1">nil</span>)
    }
}</pre></div>

<p><a href="%7B%7B%20site.asseturl%20%7D%7D/apple-pay-select-shipping-method.png" target="_blank"><img src="%7B%7B%20site.asseturl%20%7D%7D/apple-pay-select-shipping-method.png" alt="Select a Shipping Method" style="max-width:100%;"></a></p>

<p>Now, the customer can select an address and receive a different set of shipping options depending on where they live. Both the <code>shippingAddress</code> and <code>shippingMethod</code> they ultimately select will be available as properties on the <code>PKPayment</code> that is given to your delegate in the <code>paymentAuthorizationViewController:didAuthorizePayment:completion:</code> method.</p>

<blockquote>
<p>You can find all of the source code in this article at <a href="https://github.com/jflinter/ApplePayExample">https://github.com/jflinter/ApplePayExample</a>.</p>
</blockquote>

<hr>

<p>Even though Apple Pay only exposes a small number of public APIs,  its possible applications are <a href="https://itunes.apple.com/WebObjects/MZStore.woa/wa/viewFeature?id=927678292&amp;mt=8&amp;ls=1">wide-ranging</a> and you can customize your checkout flow to fit your app. It even enables you to build new types of flows, such as letting your customers buy stuff without having to create an account first.</p>

<p>As more apps start using Apple Pay (and as more customers own devices that support it), it'll become a ubiquitous way of paying for things in iOS apps. I'm excited to hear what you build with Apple Pay— if you have any questions, or want to show anything off, please <a href="mailto:jack+nshipster@stripe.com">get in touch</a>!</p>
</article></div>